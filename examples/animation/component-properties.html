<!DOCTYPE html>
<html>
<head>
    <title>Playcanvas Animation</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <link rel="icon" type="image/png" href="../playcanvas-favicon.png" />
    <script src="../../build/playcanvas.js"></script>
    <script src="../../build/playcanvas-extras.js"></script>
    <script src="http://code.playcanvas.com/pcui/pcui-v1.1.5.js"></script>
    <style>
        body { 
            margin: 0;
            overflow-y: hidden;
            display: flex;
        }
        .font-regular, .font-bold, .font-thin, .font-light {
            font-family: 'Helvetica Neue', Arial, Helvetica, sans-serif;
        }
    </style>
</head>

<body>
    <!-- The canvas element -->
    <canvas id="application-canvas"></canvas>

    <script>
        var canvas = document.getElementById("application-canvas");

        // Create the application and start the update loop
        var app = new pc.Application(canvas, {
            mouse: new pc.Mouse(document.body),
            touch: new pc.TouchDevice(document.body),
            elementInput: new pc.ElementInput(canvas)
        });
        app.start();

        // Set the canvas to fill the window and automatically change resolution to be the same as the canvas size
        app.setCanvasFillMode(pc.FILLMODE_FILL_WINDOW);
        app.setCanvasResolution(pc.RESOLUTION_AUTO);

        window.addEventListener("resize", function () {
            app.resizeCanvas(canvas.width, canvas.height);
        });

        // Create an Entity with a camera component
        var cameraEntity = new pc.Entity();
        cameraEntity.addComponent("camera", {
            clearColor: new pc.Color(0.0,0.0,0.0)
        });
        cameraEntity.translateLocal(7, 10, 7);
        cameraEntity.lookAt(0, 0, 0);

        var boxEntity = new pc.Entity();
        boxEntity.addComponent("render", {
            type: 'box'
        });
        boxEntity.name = 'model';
        boxEntity.setPosition(0, 0.25, 0);
        boxEntity.setLocalScale(0.5, 0.5, 0.5);

        app.assets.loadFromUrl(
            "../assets/textures/playcanvas-grey.png",
            "texture",
            function (err, asset) {
                var material = new pc.StandardMaterial();
                material.diffuseMap = asset.resource;
                material.update();
                boxEntity.render.meshInstances[0].material = material;
            }
        );

        var planeEntity = new pc.Entity();
        planeEntity.addComponent("render", {
            type: "plane"
        });
        planeEntity.setLocalScale(15,1,15);
        planeEntity.setPosition(0, 0, 0);

        // Create the animatible lights
        var lightsEntity = new pc.Entity();
        lightsEntity.name = 'lights';

        var light1 = new pc.Entity();
        light1.name = 'spotLight1';
        light1.addComponent("light", {
            type: "spot",
            color: new pc.Color(0.0, 0.0, 0.0, 1.0),
            intensity: 1,
            range: 15,
            innerConeAngle: 5,
            outerConeAngle: 10
        });
        light1.setPosition(0, 10, 0);

        var light2 = new pc.Entity();
        light2.name = 'spotLight2';
        light2.addComponent("light", {
            type: "spot",
            color: new pc.Color(0.0, 0.0, 0.0, 1.0),
            intensity: 1,
            range: 15,
            innerConeAngle: 5,
            outerConeAngle: 10
        });
        light2.setPosition(0, 10, 0);

        // Add Entities into the scene hierarchy
        app.root.addChild(cameraEntity);
        lightsEntity.addChild(light1);
        lightsEntity.addChild(light2);
        app.root.addChild(lightsEntity);
        app.root.addChild(boxEntity);
        app.root.addChild(planeEntity);

        // load animation assets
        var loadAsset = function (name, type, url) {
            var asset = new pc.Asset(name, type, {
                url 
            });
            app.assets.add(asset);
            app.assets.load(asset);
            return asset;
        };

        // load animation assets
        var loadAssetFromData = function (name, type, data, callback) {
            var asset = new pc.Asset(name, type, null, data);
            if (callback) {
                asset.on('load', function () { callback(asset) });
            }
            app.assets.add(asset);
            app.assets.load(asset);
            return asset;
        };

        var animClipStaticLightData = {
            "name": "staticLight",
            "duration": 1.0,
            "inputs": [
                [
                    0.0
                ]
            ],
            "outputs": [
                {
                    "components": 4,
                    "data": [
                        0.0, 1.0, 0.0, 1.0
                    ]
                },
                {
                    "components": 4,
                    "data": [
                        0.0, 0.0, 0.0, 0.0
                    ]
                }
            ],
            "curves": [
                {
                    "path": { entityPath: ["lights", "spotLight1"], component: "light", propertyPath: ["color"] },
                    "inputIndex": 0,
                    "outputIndex": 0,
                    "interpolation": 1
                },
                {
                    "path": { entityPath: ["lights", "spotLight2"], component: "light", propertyPath: ["color"] },
                    "inputIndex": 0,
                    "outputIndex": 0,
                    "interpolation": 1
                },
                {
                    "path": { entityPath: ["lights", "spotLight1"], component: "entity", propertyPath: ["localEulerAngles"] },
                    "inputIndex": 0,
                    "outputIndex": 1,
                    "interpolation": 1
                },
                {
                    "path": { entityPath: ["lights", "spotLight2"], component: "entity", propertyPath: ["localEulerAngles"] },
                    "inputIndex": 0,
                    "outputIndex": 1,
                    "interpolation": 1
                }
            ]
        };

        var animClipFlashingLightData = {
            "name": "flashingLight",
            "duration": 2.0,
            "inputs": [
                [
                    0.0, 0.5, 1.0, 1.5, 2.0
                ],
                [
                    0, 1, 2
                ]
            ],
            "outputs": [
                {
                    "components": 4,
                    "data": [
                        1.0, 0.0, 0.0, 1.0,
                        0.4, 0.0, 0.0, 1.0,
                        1.0, 0.0, 0.0, 1.0,
                        0.4, 0.0, 0.0, 1.0,
                        1.0, 0.0, 0.0, 1.0
                    ]
                },
                {
                    "components": 4,
                    "data": [
                        4.0, 0.0, 0.0, 0.0,
                        4.0, 180.0, 0.0, 0.0,
                        4.0, 0.0, 0.0, 0.0
                    ]
                },
                {
                    "components": 4,
                    "data": [
                        -4.0, 0.0, 0.0, 0.0,
                        -4.0, 180.0, 0.0, 0.0,
                        -4.0, 0.0, 0.0, 0.0
                    ]
                }
            ],
            "curves": [
                {
                    "path": { entityPath: ["lights", "spotLight1"], component: "light", propertyPath: ["color"] },
                    "inputIndex": 0,
                    "outputIndex": 0,
                    "interpolation": 1
                },
                {
                    "path": { entityPath: ["lights", "spotLight2"], component: "light", propertyPath: ["color"] },
                    "inputIndex": 0,
                    "outputIndex": 0,
                    "interpolation": 1
                },
                {
                    "path": { entityPath: ["lights", "spotLight1"], component: "entity", propertyPath: ["localEulerAngles"] },
                    "inputIndex": 1,
                    "outputIndex": 1,
                    "interpolation": 1
                },
                {
                    "path": { entityPath: ["lights", "spotLight2"], component: "entity", propertyPath: ["localEulerAngles"] },
                    "inputIndex": 1,
                    "outputIndex": 2,
                    "interpolation": 1
                }
            ]
        };

        var stateGraphData = {
            "layers": [
                {
                    "name": "Base",
                    "states": [
                        {
                            "name": "START"
                        },
                        {
                            "name": "Static",
                            "speed": 1.0
                        },
                        {
                            "name": "Flash",
                            "speed": 1.0
                        },
                        {
                            "name": "END"
                        }
                    ],
                    "transitions": [
                        {
                            "from": "START",
                            "to": "Static"
                        },
                        {
                            "from": "Static",
                            "to": "Flash",
                            "time": 1.5,
                            "interruptionSource": "NEXT_STATE",
                            "conditions": [
                                {
                                    "parameterName": "flash",
                                    "predicate": "EQUAL_TO",
                                    "value": true
                                }
                            ]
                        },
                        {
                            "from": "Flash",
                            "to": "Static",
                            "time": 1.5,
                            "interruptionSource": "NEXT_STATE",
                            "conditions": [
                                {
                                    "parameterName": "flash",
                                    "predicate": "EQUAL_TO",
                                    "value": false
                                }
                            ]
                        }
                    ]
                }
            ],
            "parameters": {
                "flash": {
                    "name": "flash",
                    "type": "BOOLEAN",
                    "value": false
                }
            }
        };

        loadAssetFromData('animClipStaticLight', 'animclip', animClipStaticLightData, function (animClipStaticLightAsset) {
        loadAssetFromData('animClipFlashingLight', 'animclip', animClipFlashingLightData, function (animClipFlashingLightAsset) {
        loadAssetFromData('stateGraph', 'animstategraph', stateGraphData, function (stateGraphAsset) {

            // add the anim component to the lights entity
            lightsEntity.addComponent("anim", {
                speed: 1.0,
                activate: true 
            });

            // load the state graph asset resource
            lightsEntity.anim.loadStateGraph(stateGraphAsset.resource);

            // assign animation clip asset resources to the appropriate states
            lightsEntity.anim.assignAnimation('Static', animClipStaticLightAsset.resource);
            lightsEntity.anim.assignAnimation('Flash', animClipFlashingLightAsset.resource);

            // controls

            var width = 201;
            var controlPanel = new pcui.Panel({
                headerText: 'Controls',
                collapsible: true,
                collapsed: false 
            });
            var toggleButton = new pcui.Button({
                text: 'Flash'
            });
            toggleButton.on('click', function() {
                var isFlashing = lightsEntity.anim.getBoolean('flash');
                lightsEntity.anim.setBoolean('flash', !isFlashing);
                toggleButton.text = isFlashing ? 'Flash' : 'Static';
            });
            controlPanel.append(toggleButton);

            controlPanel.dom.setAttribute('style', `position: fixed; right: 24px; top: 24px; width: ${width}px; z-index: 9999;`);

            document.body.appendChild(controlPanel.dom);
        });
        });
        });

    </script>
</body>
</html>
