<!DOCTYPE html>
<html>
<head>
    <title>PlayCanvas Compound Collision</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <link rel="icon" type="image/png" href="../playcanvas-favicon.png" />
    <script src="../../build/output/playcanvas.js"></script>
    <script src="../../build/output/playcanvas-extras.js"></script>
    <script src="../wasm-loader.js"></script>
    <style>
        body { 
            margin: 0;
            overflow-y: hidden;
        }
    </style>
</head>

<body>
    <!-- The canvas element -->
    <canvas id="application-canvas"></canvas>

    <!-- The script -->
    <script>
    if (wasmSupported()) {
        loadWasmModuleAsync('Ammo', '../lib/ammo/ammo.wasm.js', '../lib/ammo/ammo.wasm.wasm', demo);
    } else {
        loadWasmModuleAsync('Ammo', '../lib/ammo/ammo.js', '', demo);
    }

    function demo() {
        var canvas = document.getElementById("application-canvas");

        // Create the application and start the update loop
        var app = new pc.Application(canvas);
        app.start();

        // Set the canvas to fill the window and automatically change resolution to be the same as the canvas size
        app.setCanvasFillMode(pc.FILLMODE_FILL_WINDOW);
        app.setCanvasResolution(pc.RESOLUTION_AUTO);

        window.addEventListener("resize", function () {
            app.resizeCanvas(canvas.width, canvas.height);
        });

        var miniStats = new pc.MiniStats(app);

        app.scene.ambientLight = new pc.Color(0.2, 0.2, 0.2);

        function createMaterial (color) {
            var material = new pc.StandardMaterial();
            material.diffuse = color;
            // we need to call material.update when we change its properties
            material.update()
            return material;
        }

        // create a few materials for our objects
        var red = createMaterial(new pc.Color(1, 0.3, 0.3));
        var gray = createMaterial(new pc.Color(0.7, 0.7, 0.7));

        var scene = [
            {
                name: 'Chair',
                pos: [0, 1, 0],
                components: [
                    {
                        type: 'collision',
                        options: {
                            type: 'compound'
                        }
                    }, {
                        type: 'rigidbody',
                        options: {
                            type: 'dynamic',
                            friction: 0.5,
                            mass: 10,
                            restitution: 0.5
                        }
                    }
                ],
                children: [
                    {
                        name: 'Seat',
                        components: [
                            {
                                type: 'collision',
                                options: {
                                    type: 'box',
                                    halfExtents: [ 0.25, 0.025, 0.25 ]
                                }
                            }
                        ],
                        children: [
                            {
                                name: 'Seat Model',
                                scl: [ 0.5, 0.05, 0.5 ],
                                components: [
                                    {
                                        type: 'model',
                                        options: {
                                            type: 'box',
                                            material: gray
                                        }
                                    }
                                ]
                            }                        
                        ]
                    }, {
                        name: 'Seat Back',
                        pos: [ 0, 0.3, -0.2 ],
                        components: [
                            {
                                type: 'collision',
                                options: {
                                    type: 'box',
                                    halfExtents: [ 0.25, 0.2, 0.025 ]
                                }
                            }
                        ],
                        children: [
                            {
                                name: 'Seat Back Model',
                                scl: [ 0.5, 0.4, 0.05 ],
                                components: [
                                    {
                                        type: 'model',
                                        options: {
                                            type: 'box',
                                            material: gray
                                        }
                                    }
                                ]
                            }                        
                        ]
                    }, {
                        name: 'Leg 1',
                        pos: [ 0.2, -0.25, 0.2 ],
                        components: [
                            {
                                type: 'collision',
                                options: {
                                    type: 'cylinder',
                                    height: 0.5,
                                    radius: 0.025
                                }
                            }
                        ],
                        children: [
                            {
                                name: 'Leg 1 Model',
                                scl: [ 0.05, 0.5, 0.05 ],
                                components: [
                                    {
                                        type: 'model',
                                        options: {
                                            type: 'cylinder',
                                            material: gray
                                        }
                                    }
                                ]
                            }                        
                        ]
                    }, {
                        name: 'Leg 2',
                        pos: [ -0.2, -0.25, 0.2 ],
                        components: [
                            {
                                type: 'collision',
                                options: {
                                    type: 'cylinder',
                                    height: 0.5,
                                    radius: 0.025
                                }
                            }
                        ],
                        children: [
                            {
                                name: 'Leg 2 Model',
                                scl: [ 0.05, 0.5, 0.05 ],
                                components: [
                                    {
                                        type: 'model',
                                        options: {
                                            type: 'cylinder',
                                            material: gray
                                        }
                                    }
                                ]
                            }                        
                        ]
                    }, {
                        name: 'Leg 3',
                        pos: [ 0.2, 0, -0.2 ],
                        components: [
                            {
                                type: 'collision',
                                options: {
                                    type: 'cylinder',
                                    height: 1,
                                    radius: 0.025
                                }
                            }
                        ],
                        children: [
                            {
                                name: 'Leg 3 Model',
                                scl: [ 0.05, 1, 0.05 ],
                                components: [
                                    {
                                        type: 'model',
                                        options: {
                                            type: 'cylinder',
                                            material: gray
                                        }
                                    }
                                ]
                            }                        
                        ]
                    }, {
                        name: 'Leg 4',
                        pos: [ -0.2, 0, -0.2 ],
                        components: [
                            {
                                type: 'collision',
                                options: {
                                    type: 'cylinder',
                                    height: 1,
                                    radius: 0.025
                                }
                            }
                        ],
                        children: [
                            {
                                name: 'Leg 4 Model',
                                scl: [ 0.05, 1, 0.05 ],
                                components: [
                                    {
                                        type: 'model',
                                        options: {
                                            type: 'cylinder',
                                            material: gray
                                        }
                                    }
                                ]
                            }                        
                        ]
                    }
                ]
            }, {
                name: 'Ground',
                pos: [ 0, -0.5, 0 ],
                components: [
                    {
                        type: 'collision',
                        options: {
                            type: 'box',
                            halfExtents: [ 5, 0.5, 5 ]
                        }
                    }, {
                        type: 'rigidbody',
                        options: {
                            type: 'static',
                            restitution: 0.5
                        }
                    }
                ],
                children: [
                    {
                        name: 'Ground Model',
                        scl: [ 10, 1, 10 ],
                        components: [
                            {
                                type: 'model',
                                options: {
                                    type: 'box',
                                    material: gray
                                }
                            }
                        ]
                    }                        
                ]
            }, {
                name: 'Directional Light',
                rot: [ 45, 30, 0 ],
                components: [
                    {
                        type: 'light',
                        options: {
                            type: 'directional',
                            castShadows: true,
                            shadowDistance: 8,
                            shadowBias: 0.05,
                            normalOffsetBias: 0.05
                        }
                    }
                ]
            }, {
                name: 'Camera',
                pos: [ 0, 4, 7 ],
                rot: [ -30, 0, 0 ],
                components: [
                    {
                        type: 'camera',
                        options: {
                            color: [ 0.5, 0.5, 0.5 ]
                        }
                    }
                ]
            }
        ];

        function parseEntity(e) {
            var entity = new pc.Entity(e.name);

            if (e.pos) {
                entity.setLocalPosition(e.pos[0], e.pos[1], e.pos[2]);
            }
            if (e.rot) {
                entity.setLocalEulerAngles(e.rot[0], e.rot[1], e.rot[2]);
            }
            if (e.scl) {
                entity.setLocalScale(e.scl[0], e.scl[1], e.scl[2]);
            }

            if (e.components) {
                e.components.forEach(function (c) {
                    entity.addComponent(c.type, c.options);
                });
            }

            if (e.children) {
                e.children.forEach(function (child) {
                    entity.addChild(parseEntity(child));
                });
            }

            return entity;
        }

        function parseScene(s) {
            s.forEach(function (e) {
                app.root.addChild(parseEntity(e));
            });
        }

        parseScene(scene);

        var numChairs = 0;

        function spawnChair() {
            var chair = app.root.findByName('Chair');
            var clone = chair.clone();
            clone.setLocalPosition(Math.random() * 5 - 2.5, Math.random() * 2 + 1, Math.random() * 5 - 2.5)
            app.root.addChild(clone);
            numChairs++;
        }

        // Set an update function on the application's update event
        var time = 0;
        app.on("update", function (dt) {
            time += dt;
            if (time > 0.25 && numChairs < 100) {
                spawnChair();
                time = 0;
            }

            // Show active bodies in red and frozen bodies in gray
            app.root.findComponents('rigidbody').forEach(function (body) {
                body.entity.findComponents('model').forEach(function (model) {
                    model.material = body.isActive() ? red : gray;
                });
            });
        });
    }
    </script>
</body>
</html>
