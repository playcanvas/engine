<!DOCTYPE html>
<html>
<head>
    <title>PlayCanvas Baked Lights - Render Component</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <link rel="icon" type="image/png" href="../playcanvas-favicon.png" />
    <script src="../../build/playcanvas.js"></script>
    <script src="../../build/playcanvas-extras.js"></script>
    <style>
        body {
            margin: 0;
            overflow-y: hidden;
        }
    </style>
</head>

<body>
    <!-- The canvas element -->
    <canvas id="application-canvas"></canvas>

    <!-- The script -->
    <script>
        var canvas = document.getElementById("application-canvas");

        // Create the application and start the update loop
        var app = new pc.Application(canvas);
        app.start();

        // Set the canvas to fill the window and automatically change resolution to be the same as the canvas size
        app.setCanvasFillMode(pc.FILLMODE_FILL_WINDOW);
        app.setCanvasResolution(pc.RESOLUTION_AUTO);

        window.addEventListener("resize", function () {
            app.resizeCanvas(canvas.width, canvas.height);
        });

        var miniStats = new pcx.MiniStats(app);

        app.scene.ambientLight = new pc.Color(0.1, 0.1, 0.1);

        var material = new pc.StandardMaterial();
        material.shininess = 60;
        material.useMetalness = true;
        material.metalness = 0.03;
        material.update();

        // All render component primitive shape types
//        var shapes = ["box", "cone", "cylinder", "sphere", "capsule"];
        var shapes = ["box"];

        for (var i = 0; i <20; i++) {
            var shape = shapes[Math.floor(Math.random() * shapes.length)];

            // Create an entity with a render component that is set up to be lightmapped with baked direct lighting
            var entity = new pc.Entity("Primitive" + i);
            entity.addComponent(Math.random() < 0.5 ? 'render' : 'model', {
                castShadows: false,
                castShadowsLightmap: true,
               lightmapped: true,
                type: shape,
                material: material
            });
            app.root.addChild(entity);

            // random orientation
            let scale = 1 + Math.random() * 2;
            entity.setLocalPosition(Math.random() * 14 - 7, 0.5 * scale, Math.random() * 14 - 7);
            entity.setLocalScale(scale, scale, scale);
        };

        var ground = new pc.Entity("Ground");
        ground.addComponent('render', {
            castShadows: false,
            castShadowsLightmap: false,
            lightmapped: true,
            type: "plane",
            material: material
        });
        app.root.addChild(ground);
        ground.setLocalPosition(0, 0, 0);
        ground.setLocalScale(40, 40, 40);


        // var lights = [];
        // var count = 450;
        // for (var l = 0; l < count; l++) {
        //     var light = new pc.Entity("Directional");
        //     light.addComponent("light", {
        //         affectDynamic: true,
        //         affectLightmapped: false,
        //         bake: true,
        //         castShadows: true,
        //         normalOffsetBias: 0.05,
        //         shadowBias: 0.2,
        //         shadowDistance: 50,
        //         shadowResolution: 2048,
        //         shadowType: pc.SHADOW_PCF3,
        //         color: pc.Color.WHITE,
        //         intensity: 2 / count,
        //         type: "directional"
        //     });
        //     app.root.addChild(light);
        //     lights.push(light);

        //     var p = l > (count * 1) ? 20 : 90;
        //     var p2 = p * 0.5;
        //     light.setLocalEulerAngles(-45 + Math.random() * p - p2, 0, Math.random() * p - p2);
        // }



        // Create an entity with a directional light component that is configured as a baked light
        var light = new pc.Entity("Directional");
        light.addComponent("light", {
            affectDynamic: false,
            affectLightmapped: true,
            bake: true,
            castShadows: true,
            normalOffsetBias: 0.05,
            shadowBias: 0.2,
            shadowDistance: 50,
            shadowResolution: 2048,
            shadowType: pc.SHADOW_PCF3,
            color: pc.Color.GREEN,
            intensity: 0.3,
            type: "directional"
        });
        app.root.addChild(light);
        light.setLocalEulerAngles(45, 30, 0);

        // Create an entity with a point light component that is configured as a baked light
        var lightPoint = new pc.Entity("Point");
        lightPoint.addComponent("light", {
            affectDynamic: false,
            affectLightmapped: true,
            bake: true,
            castShadows: true,
            normalOffsetBias: 0.05,
            shadowBias: 0.2,
            shadowDistance: 50,
            shadowResolution: 512,
            shadowType: pc.SHADOW_PCF3,
            color: pc.Color.RED,
            range: 100,
            type: "point"
        });
        lightPoint.setLocalPosition(-6, 4, 0);
        app.root.addChild(lightPoint);

        // Create an entity with a spot light component that is configured as a baked light
        var lightSpot = new pc.Entity("Spot");
        lightSpot.addComponent("light", {
            affectDynamic: false,
            affectLightmapped: true,
            bake: true,
            castShadows: true,
            normalOffsetBias: 0.05,
            shadowBias: 0.2,
            shadowDistance: 50,
            shadowResolution: 512,
            shadowType: pc.SHADOW_PCF3,
            color: pc.Color.BLUE,
            range: 100,
            type: "spot"
        });
        lightSpot.setLocalPosition(5, 7, 0);
        app.root.addChild(lightSpot);


        // Create an entity with a camera component
        var camera = new pc.Entity();
        camera.addComponent("camera", {
            clearColor: new pc.Color(0.4, 0.45, 0.5),
            farClip: 100,
            nearClip: 0.05
        });
        app.root.addChild(camera);

        // var bakeType = pc.BAKE_COLOR;
        var bakeType = pc.BAKE_COLORDIR;



        // var url = "../assets/models/temple.glb";
        // app.assets.loadFromUrl(url, "container", function (err, asset) {
        //     this.entity = new pc.Entity();
        //     this.entity.addComponent("model", {
        //         type: "asset",
        //         asset: asset.resource.model,
        //         castShadows: true
        //     });
        //     app.root.addChild(this.entity);

        //     this.entity.model.castShadowsLightmap = true;
        //     this.entity.model.lightmapped = true;


        //     // lightmap baking properties
        //     app.scene.lightmapMode = bakeType;
        //     app.scene.lightmapMaxResolution = 2048;

        //     // For baked lights, this property perhaps has the biggest impact on lightmap resolution:
        //     app.scene.lightmapSizeMultiplier = 32;

        //     // bake lightmaps
        //     app.lightmapper.bake(null, bakeType);

        // });
        

        // lightmap baking properties
        app.scene.lightmapMode = bakeType;
        app.scene.lightmapMaxResolution = 2048;

        // For baked lights, this property perhaps has the biggest impact on lightmap resolution:
        app.scene.lightmapSizeMultiplier = 32;

        // bake lightmaps
        app.lightmapper.bake(null, bakeType);
       // app.lightmapper.bake([ground], bakeType);

    //    for (var l = 0; l < lights.length; l++) {
    //     lights[l].destroy();
    //    }

        // Set an update function on the app's update event
        var time = 7;
        var bake = true;
        app.on("update", function (dt) {
            time += dt;

            if (time > 7 && bake) {
                bake = false;
                console.log("bake");
                app.lightmapper.bake([ground], bakeType);
//                app.lightmapper.bake(null, bakeType);
            }

            // orbit camera
            camera.setLocalPosition(20 * Math.sin(time * 0.4), 12, 20);
            camera.lookAt(pc.Vec3.ZERO);
        });

    </script>
</body>
</html>