<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>USDZ Test</title>
    <meta name="description" content="WebGPU Test" />
    <style>
        #button {
            position: absolute;
            top: 200px;
            left: calc(50% - 400px);

        }
    </style>

    <script src="../../build/playcanvas.dbg.js"></script>
    <script src="../../build/playcanvas-extras.js"></script>

</head>
<body style="margin: 0px;">
    <div style="width:100%; position:absolute; top:10px">
        <div style="text-align: center;">
            <a id="link" rel="ar" href="" download="asset.usdz">
                <img id="button" width="500" src="arkit.png">
            </a>    
        </div>
    </div>
    <canvas id='application'></canvas>
    <script type="module">

        const assets = {
            'helipad': new pc.Asset('helipad.dds', 'cubemap', { url: '../assets/cubemaps/helipad.dds' }, { type: pc.TEXTURETYPE_RGBM }),
            'glb': new pc.Asset('model', 'container', { url: '../assets/models/bench_wooden_01.glb' }),
        };

        function onLoaded(app) {

            app.start();

            app.scene.skyboxMip = 2;
            app.scene.setSkybox(assets['helipad'].resources);
            app.scene.skyboxIntensity = 1;

            const camera = new pc.Entity();
            camera.addComponent("camera", {
                clearColor: new pc.Color(0.4, 0.4, 0.4, 1)
            });
            app.root.addChild(camera);
            camera.setLocalPosition(0, 0, 25);

            const modelEntity = assets.glb.resource.instantiateRenderEntity({
            });
            app.root.addChild(modelEntity);

            new pcx.UsdzExporter().build(modelEntity).then((arrayBuffer) => {
                const blob = new Blob([arrayBuffer], { type: 'application/octet-stream' } );
                const link = document.getElementById( 'link' );
                link.href = URL.createObjectURL( blob );
            }).catch(console.error);
        }

        function main() {

            const canvas = document.getElementById('application');
            const app = new pc.Application(canvas);
            app.setCanvasFillMode(pc.FILLMODE_FILL_WINDOW);
            app.setCanvasResolution(pc.RESOLUTION_AUTO);

            const assetListLoader = new pc.AssetListLoader(Object.values(assets), app.assets);
            assetListLoader.load(() => {
                onLoaded(app);
            });
        }

        window.addEventListener('load', main);
    </script>
</body>
</html>
